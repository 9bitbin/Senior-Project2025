<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vidia - Fasting</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
    
</head>
<body>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        
        const REQUIRED_FIELDS = [
          "name", "age", "weight", "height", "dob", "sex", "calorieGoal", "exerciseType",
          "healthGoals", "activityLevel", "dietType", "sleepHours", "waterIntakeGoal",
          "preferredWorkoutTime", "mentalHealthFocus"
        ];
        
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            window.location.href = "index.html";
            return;
          }
          const userDocRef = doc(db, "users", user.uid);
          const userDoc = await getDoc(userDocRef);
          if (!userDoc.exists()) {
            window.location.href = "profile.html";
            return;
          }
          const data = userDoc.data();
          const incomplete = REQUIRED_FIELDS.some(field => !data[field] || data[field] === "");
          if (incomplete && !window.location.pathname.endsWith("profile.html")) {
            window.location.href = "profile.html";
          }
        });
        </script>

    <script src="sidebar.js" defer></script>
  <!-- üîπ Main Content -->
  <div class="main-content">
    <div class="fasting-tracker">
      <div class="section-box main-container">
        <h2>‚è≥ Intermittent Fasting Tracker</h2>
    
        <div class="timer-wrapper">
            <div id="fasting-timer">00h 00m 00s</div>
            <div class="fasting-type-indicator">12:12 (12 hours fasting, 12 hours eating)</div>
        </div>

        <div class="fasting-stats">
            <div class="stat-card">
                <span class="stat-icon">‚≠ê</span>
                <h4>Total Fasts</h4>
                <p id="total-fasts">0</p>
            </div>
            <div class="stat-card">
                <span class="stat-icon">‚è±Ô∏è</span>
                <h4>Average Duration</h4>
                <p id="avg-duration">0 hrs</p>
            </div>
            <div class="stat-card">
                <span class="stat-icon">üéØ</span>
                <h4>Completion Rate</h4>
                <p id="completion-rate">0%</p>
            </div>
        </div>
      </div>

      <div class="section-box">
        <div class="fasting-chart-container">
            <h3>Last 7 Days of Fasting Activity</h3>
            <canvas id="fastingChart"></canvas>
        </div>

        <div class="controls-section">
            <label for="fasting-window">Choose Fasting Schedule:</label>
            <select id="fasting-window">
          <option value="12">12:12 (12 hours fasting, 12 hours eating)</option>
          <option value="14">14:10 (14 hours fasting, 10 hours eating)</option>
          <option value="16">16:8 (16 hours fasting, 8 hours eating)</option>
          <option value="18">18:6 (18 hours fasting, 6 hours eating)</option>
          <option value="20">20:4 (20 hours fasting, 4 hours eating)</option>
          <option value="24">24 Hour Fast</option>
      </select>
            
            <div class="button-group">
                <button id="start-fasting" class="start-btn">üöÄ Start Fasting</button>
                <button id="end-fasting" class="end-btn" disabled>‚èπ End Fasting</button>
                <button id="resume-fasting" class="resume-btn" disabled>‚ñ∂Ô∏è Resume Fasting</button>
                <button id="download-fasting">üì• Download Fasting History (CSV)</button>
            </div>
            
            <p><strong>Status:</strong> <span id="fasting-status">Not Started</span></p>
            <p id="daily-fast-message" style="color: #e11d48; font-size: 0.9em; margin-top: 5px;"></p>
        </div>
      </div>

      <div class="section-box">
        <h3>üìú Fasting History <button class="collapse-btn" onclick="toggleHistory()">‚ñº</button></h3>
        <div class="date-filter-container">
            <div class="date-filter-inputs">
                <div class="date-input-group">
                    <label>Start Date</label>
                    <input type="date" id="filter-start-date">
                </div>
                <div class="date-input-group">
                    <label>End Date</label>
                    <input type="date" id="filter-end-date">
                </div>
                <div>
                    <button class="filter-btn">üîç Filter</button>
                    <button class="reset-filter-btn">‚Ü∫ Reset</button>
                </div>
            </div>
        </div>
      </div>

      <div class="history-container collapsed" id="historyContainer">
          <ul id="fasting-history" class="fasting-history-list"></ul>
      </div>

      <style>
          /* Chart improvements */
          .fasting-chart-container {
              height: 350px;
              margin: 20px 0;
          }

          #fastingChart {
              width: 100% !important;
              height: 100% !important;
              image-rendering: -webkit-optimize-contrast;
              image-rendering: crisp-edges;
          }

          /* History section styling */
          .history-container {
              background: #f8f9fa;
              border-radius: 8px;
              padding: 15px;
              margin-top: 15px;
              max-height: 500px;
              overflow-y: auto;
              transition: max-height 0.3s ease-out;
              border: 1px solid #e2e8f0;
          }

          .history-container.collapsed {
              max-height: 0;
              padding: 0;
              overflow: hidden;
              border: none;
          }

          .collapse-btn {
              background: #f0f0f0;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 1.2em;
              cursor: pointer;
              padding: 2px 8px;
              margin-left: 10px;
              transition: transform 0.3s, background-color 0.2s;
          }

          .collapse-btn:hover {
              background: #e0e0e0;
          }

          .collapse-btn.collapsed {
              transform: rotate(-90deg);
          }
      </style>

      <script>
          function toggleHistory() {
              const container = document.getElementById('historyContainer');
              const btn = document.querySelector('.collapse-btn');
              container.classList.toggle('collapsed');
              btn.classList.toggle('collapsed');
              btn.textContent = container.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
          }
      </script>
      
    </div>
  </div>

  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="fasting.js"></script>
</body>
</html>